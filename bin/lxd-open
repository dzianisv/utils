#!/bin/bash
set -xe
CONTAINER_NAME=$1
COMMAND=${2:-bash}

if [ -z  "$CONTAINER_NAME" ]; then
    echo "Usage: ENABLE_X=1 ENABLE_VIDEO=1 lxd-open <container name>"
    exit 1
fi

PROFILES="default"

if [ -n "$ENABLE_X" ]; then
    if ! lxc profile show graphic; then
        lxc profile create graphic
        lxc profile device add graphic X11 disk path=/host/.X11-unix/ source=/tmp/.X11-unix/
        lxc profile device add graphic GPU gpu
        lxc profile device set graphic GPU gid 44 # vidoe
        lxc profile set graphic environment.DISPLAY :0
        lxc profile set graphic environment.XAUTHORITY /host/.Xauthority
    fi

    sudo chmod a+rwx /tmp/.X11-unix
    PROFILES="$PROFILES,graphic"
fi

if [ -n "$ENABLE_VIDEO" ]; then
    lxc profile create video
    for dev in /dev/video*; do
        DEVICE_NAME=$(basename "$dev")
        lxc profile device add video "$DEVICE_NAME" unix-char path=$dev
        lxc profile device set video "$DEVICE_NAME" gid 44 # video
    done
    PROFILES="$PROFILES,video"
fi

if [ -n "$ENABLE_NETFILTER" ]; then
    if ! lxc profile show netfilter; then
        lxc profile create netfilter
        lxc profile set netfilter linux.kernel_modules br_netfilter
    fi
    PROFILES="$PROFILES,netfilter"
fi

if [ -n "$ENABLE_AUDIO" ]; then
    if ! lxc profile show audio; then
        lxc profile create audio
        lxc profile device add audio pulse-audio proxy connect=unix:/host/pulse-native listen=unix:/run/user/$(id -u)/pulse/native
	lxc profile device set audio pulse-audio gid 29 #audio
        lxc profile set audio environment.PULSE_SERVER unix:/host/pulse-native
    fi
    PROFILES="$PROFILES,audio"
fi

lxc profile assign "${CONTAINER_NAME}" "$PROFILES"

if ! lxc info "${CONTAINER_NAME}" | grep "Status: Running"; then
    lxc start "${CONTAINER_NAME}"
    while [[ ! $(lxc exec "${CONTAINER_NAME}" -- systemctl is-system-running) =~ (degraded)|(running) ]]; do sleep 1; done
fi

if [ -n "$ENABLE_X" ]; then
    xhost + local:
    lxc file push "${XAUTHORITY}" "${CONTAINER_NAME}/host/.Xauthority"
    lxc exec "${CONTAINER_NAME}" -- chmod a+r /host/.Xauthority
    # create symlink to the X11 unix sockets, we can't mount it to /tmp/.X11-unix in profile, because systemd mounts tmpfs to tmp during start and masks it
    lxc exec "${CONTAINER_NAME}" -- rmdir  /tmp/.X11-unix || :
    lxc exec "${CONTAINER_NAME}" -- ln -snf /host/.X11-unix /tmp/ || :
fi

if [ -n "$ENABLE_AUDIO" ]; then
    lxc exec "${CONTAINER_NAME}" -- sed -i "s/; enable-shm = yes/enable-shm = no/g" /etc/pulse/client.conf
fi

lxc exec "${CONTAINER_NAME}" -- bash -c "$COMMAND"
lxc stop "${CONTAINER_NAME}"
