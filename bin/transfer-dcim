#!/bin/bash
# Merges current workdir to the $1 dir (Destination Directory)
# Duplicate files (files with the same hash sum) will be remove from the Working Directory
# Files with the same file_name will be refile_named and moved to the Destination Directory
# Unique files will be moved from the Working Directory to the Destination Directory

set -ueo pipefail


MEDIA_DIRS=("PRIVATE/M4ROOT/CLIP", "DCIM/100MSDCF")
MEDIA_EXTENSIONS=("*.MP4", "*.JPG", "*.ARW")
TMP_EXTENSIONS=("*.THM", "*.XML")

get_file_modification_time() {
    date -r $(stat -f %m "$1" 2>/dev/null) +"%Y-%m-%d-%H-%M-%S"
}

transfer() {
    destination=$1
    shift

    rsync -r -t l --progress=status -e "ssh -o Ciphers=chacha20-poly1305@openssh.com" --remove-source-files "$*" "${destination}"
}

transfer() {
    TARGET_DIR=${1:?Target directory is required}

    if [ ! -d "$TARGET_DIR" ]; then
        echo "Target directory $TARGET_DIR doesn't exist"
        exit 1
    fi

    for VOLUME in /Volumes/*; do
        if [[ -d "${VOLUME}" ]]; then
            for DIR in "${MEDIA_DIRS[@]}"; do
                SRC_DIR="${VOLUME}/${DIR}"
                if [[ -d "${SRC_DIR}" ]]; then
                    for EXT in "${MEDIA_EXTENSIONS[@]}"; do
                        transfer "${TARGET_DIR}" "${SRC_DIR}"/*."${EXT}"
                    done

                    for TMP_EXTENSION in "${TMP_EXTENSIONS[@]}"; do
                        rm "${SRC_DIR}"/*."${TMP_EXTENSION}"
                    done
                fi
            done
        fi
    done
}

tranfer "$1"
